{% extends "layout.html" %}
{% load static %}
{% block title %}Student List{% endblock %}

{% block Main_content %}
<div class="container-fluid" style="margin-top:5%;">

    <div class="row">
        <div class="col-12">
            <div class="card card-margin" style="box-shadow:none; border:none;">
                <div class="card-body">

                    <!-- RESULT HEADER -->
                    <div class="result-header mb-3">
                        <div class="result-header mb-3">
                            <div class="row align-items-center">

                                <div class="col-12 col-lg-4 mb-2 mb-lg-0">
                                    <div class="records">
                                        Showing:
                                        <b>{{ students.start_index }}-{{ students.end_index }}</b>
                                        of <b>{{ students.paginator.count }}</b> results
                                    </div>
                                </div>

                                <div class="col-12 col-lg-8 mt-5 mt-lg-0">
                                    <form method="get" class="row g-2 justify-content-end align-items-center">

                                        <div class="col-6 col-sm-6 col-md-auto">
                                            <input type="text"
                                                name="roll"
                                                class="form-control form-control-sm"
                                                placeholder="e.g. 1,2,3,4,5"
                                                value="{{ request.GET.roll }}">
                                        </div>

                                        <div class="col-6 col-sm-6 col-md-auto">
                                            <select name="status" class="form-control form-control-sm">
                                                <option value="">All Status</option>
                                                {% for key, val in students.paginator.object_list.model.ID_STATUS_CHOICES %}
                                                    <option value="{{ key }}" {% if request.GET.status == key %}selected{% endif %}>
                                                        {{ val }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <div class="col-6 col-sm-6 col-md-auto">
                                            <select name="section" class="form-control form-control-sm">
                                                <option value="">All Sections</option>
                                                {% for key, val in section_choices %}
                                                    <option value="{{ key }}" {% if request.GET.section == key %}selected{% endif %}>
                                                        {{ val }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <div class="col-6 col-sm-6 col-md-auto">
                                            <select name="sort" class="form-control form-control-sm">
                                                <option value="">Sort By</option>
                                                <option value="az" {% if request.GET.sort == 'az' %}selected{% endif %}>Name (A-Z)</option>
                                                <option value="za" {% if request.GET.sort == 'za' %}selected{% endif %}>Name (Z-A)</option>
                                                <option value="roll" {% if request.GET.sort == 'roll' %}selected{% endif %}>Roll No</option>
                                            </select>
                                        </div>

                                        <div class="col-6 col-sm-6 col-md-auto">
                                            <button type="button"
                                                    class="btn btn-dark btn-sm w-100"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#studentModal">
                                                <i class="bi bi-plus-lg"></i> New Student
                                            </button>
                                        </div>

                                        <div class="col-6 col-sm-6 col-md-auto">
                                            <button type="submit" class="btn btn-dark btn-sm w-100">
                                                <i class="bi bi-funnel"></i> Filter
                                            </button>
                                        </div>

                                        <div class="col-12 col-sm-6 col-md-auto">
                                            <a href="{% url 'export_id_cards' class_id=class_id %}?section={{ request.GET.section }}&status={{ request.GET.status }}&roll={{ request.GET.roll }}"
                                            target="_blank"
                                            class="btn btn-dark btn-sm w-100">
                                                <i class="bi bi-printer"></i> Print
                                            </a>
                                        </div>

                                    </form>
                                </div>
                            </div>
                        </div>



                    <!-- RESULT BODY: Table -->
                    <div class="result-body">
                        <div class="table-responsive">
                            <table class="table widget-26">
                                <thead>
                                    <tr>
                                        <th>Roll <span class="d-none d-md-inline">No</span></th>
                                        <th>Photo</th>
                                        <th>Full Name</th>
                                        <th>Grade & Section</th>   
                                        <th>Valid Until</th>
                                        <th>Parent Name</th>
                                        <th>Parent Contact</th>
                                        <th>Status</th>
                                        <th>Issue Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in students %}
                                    <tr>
                                        <td>{{ student.roll }}</td>
                                        <td>
                                            <div class="widget-26-job-emp-img">
                                                <img src="{{ student.get_photo_url }}" alt="{{ student.full_name }}">
                                            </div>
                                        </td>
                                        <td>{{ student.full_name }}</td>
                                        <td>{{ student.grade }} - {{ student.section|default:"-" }}</td>
                                        <td>{{ student.valid_until|date:"M d, Y" }}</td>
                                        <td>{{ student.parent_name|default:"-" }}</td>
                                        <td>{{ student.parent_phone|default:"-" }}</td>
                                        <td>
                                            <div class="widget-26-job-category indicator-wrap
                                                {% if student.status == 'ACTIVE' %}bg-soft-success{% endif %}
                                                {% if student.status == 'LOST' %}bg-soft-danger{% endif %}
                                                {% if student.status == 'NEW' %}bg-soft-warning{% endif %}
                                                {% if student.status == 'REISSUED' %}bg-soft-info{% endif %}">
                                                <i class="indicator
                                                    {% if student.status == 'ACTIVE' %}bg-success{% endif %}
                                                    {% if student.status == 'LOST' %}bg-danger{% endif %}
                                                    {% if student.status == 'NEW' %}bg-warning{% endif %}
                                                    {% if student.status == 'REISSUED' %}bg-info{% endif %}">
                                                </i>
                                                <span>{{ student.get_status_display }}</span>
                                            </div>
                                        </td>
                                        <td>{{ student.created_at|date:"M d, Y" }}</td>
                                        <td class="d-flex gap-1">
                                            <!-- Edit -->
                                            <button type="button" class="btn btn-sm btn-dark edit-btn"
                                                data-bs-toggle="modal"
                                                data-bs-target="#studentModal"
                                                data-id="{{ student.id }}"
                                                data-full_name="{{ student.full_name }}"
                                                data-roll="{{ student.roll }}"
                                                data-gender="{{ student.gender }}"
                                                data-grade="{{ student.grade }}"
                                                data-section="{{ student.section }}"
                                                data-status="{{ student.status }}"
                                                data-parent_name="{{ student.parent_name }}"
                                                data-parent_phone="{{ student.parent_phone }}"
                                                data-address="{{ student.address }}"
                                                data-dob="{{ student.dob }}"
                                                data-valid_until="{{ student.valid_until }}">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>

                                            <!-- Delete -->
                                            <form method="post" action="{% url 'delete_student' student.id %}" onsubmit="return confirm('Are you sure?');">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-dark">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="12" class="text-center text-muted">No students found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <nav class="d-flex justify-content-center mt-3">
                        <ul class="pagination pagination-base pagination-boxed pagination-square mb-0">
                            {% if students.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ students.previous_page_number }}">&laquo; Previous</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled"><span class="page-link">&laquo; Previous</span></li>
                            {% endif %}

                            {% for num in students.paginator.page_range %}
                            <li class="page-item {% if students.number == num %}active{% endif %}">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                            {% endfor %}

                            {% if students.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ students.next_page_number }}">Next &raquo;</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled"><span class="page-link">Next &raquo;</span></li>
                            {% endif %}
                        </ul>
                    </nav>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- ADD / EDIT STUDENT MODAL -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form id="studentForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="student_id" id="studentId">

                <div class="modal-body">
                    <div class="row g-2">

                        <div class="col-md-6">
                            <label class="form-label small">Full Name</label>
                            <input type="text" name="full_name" id="fullName" class="form-control form-control-sm" required>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small">Roll</label>
                            <input type="text" name="roll" id="roll" class="form-control form-control-sm" required>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small">Gender</label>
                            <select name="gender" id="gender" class="form-control form-control-sm" required>
                                {% for k, v in gender_choices %}
                                    <option value="{{ k }}">{{ v }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small">Grade</label>
                            <select name="grade" id="grade" class="form-control form-control-sm" required>
                                <option value="{{ class_id }}">{{ class_id }}</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small">Section</label>
                            <select name="section" id="section" class="form-control form-control-sm" required>
                                {% for k, v in section_choices %}
                                    <option value="{{ k }}">{{ v }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small">Status</label>
                            <select name="status" id="status" class="form-control form-control-sm" required>
                                {% for k, v in students.paginator.object_list.model.ID_STATUS_CHOICES %}
                                    <option value="{{ k }}">{{ v }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small">DOB</label>
                            <input type="date" name="dob" id="dob" class="form-control form-control-sm" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small">Valid Until</label>
                            <input type="date" name="valid_until" id="validUntil" class="form-control form-control-sm">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small">Parent Name</label>
                            <input type="text" name="parent_name" id="parentName" class="form-control form-control-sm" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small">Parent Phone</label>
                            <input type="text" name="parent_phone" id="parentPhone" class="form-control form-control-sm" required>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label small">Address</label>
                            <textarea name="address" id="address" class="form-control form-control-sm" rows="2" required></textarea>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label small">Photo</label>
                            <input type="file" name="photo" id="photo" accept="image/*" class="form-control form-control-sm">
                        </div>

                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-dark btn-sm">Save</button>
                </div>
            </form>

        </div>
    </div>
</div>


<!-- JS: Populate Modal for Edit -->
<script>
const form = document.getElementById('studentForm');
const modalTitle = document.getElementById('modalTitle');

document.getElementById('addStudentBtn').addEventListener('click', () => {
    modalTitle.innerText = 'Add Student';
    form.action = "{% url 'add_student' %}";
    form.reset();
    document.getElementById('studentId').value = '';
});

document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function () {
        modalTitle.innerText = 'Edit Student';
        form.action = `/student/${this.dataset.id}/edit/`;

        document.getElementById('studentId').value = this.dataset.id;
        document.getElementById('fullName').value = this.dataset.full_name;
        document.getElementById('roll').value = this.dataset.roll;
        document.getElementById('gender').value = this.dataset.gender;
        document.getElementById('grade').value = this.dataset.grade;
        document.getElementById('section').value = this.dataset.section;
        document.getElementById('status').value = this.dataset.status;
        document.getElementById('parentName').value = this.dataset.parent_name;
        document.getElementById('parentPhone').value = this.dataset.parent_phone;
        document.getElementById('address').value = this.dataset.address;

        // DOB and Valid Until
        if (this.dataset.dob) document.getElementById('dob').value = this.dataset.dob;
        if (this.dataset.valid_until) document.getElementById('validUntil').value = this.dataset.valid_until;
    });
});
</script>

{% endblock %}
